---
title: "FY25 Official Forecast for FY26 Foundation Payment: Percentage-Based Method"
author: "Kristen Mosley"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: hide
    df_print: paged
    highlight: tango
    smooth_scroll: true
params:
  merged_data: "data/CCF_FundYear25 09OCT25_merged.xlsx"
  forecasts: "ets-forecasts/fy25-official-ets-forecasts.xlsx"
  existing_outliers: "final-forecasts/fy25-official-forecast-outliers.xlsx"
---

<style>
/* Improve readability of code and outputs */
pre { overflow-x: auto; }
pre code { word-wrap: normal; white-space: pre; }

/* Style tables for clarity */
table {
  border-collapse: collapse;
  margin: 1em 0;
}
th, td {
  padding: 6px 12px;
  border: 1px solid #ddd;
}
</style>

## PCT Document Summary

This document applies the **Percentage-based (PCT) forecasting method**, which uses each institution’s **average historical subgroup percentages** to project how forecast credentials (from the ETS method) will be distributed across subgroups. Specifically, it estimates the percentage of credentials awarded in **high-demand fields** and to students who are **academically disadvantaged, economically disadvantaged, and/or adult learners**. 

First, the **annual subgroup percentages** are calculated, which define the percentage of total credentials conferred to each subgroup in a given year. Second, the **average historical subgroup percentages** are calculated, which define the multi-year average of the annual subgroup percentages for each relevant subgroup. 

The outputs include intermediate, annual historical averages saved in the pct-averages/ folder and final combined forecast files saved in the final-forecasts/ folder. The combined forecast output integrates both ETS and PCT results into a single data frame ready for input into the community college funding model.

## Global Setup
```{r, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)

library(openxlsx)
library(purrr)
library(tidyverse)
library(ggplot2)
library(knitr)
library(kableExtra)
```

## Quality Control Functions: 
* log_qc
* summarize_qc
* check_forecast_outliers
* check_required_vars
```{r pct_qc_functions}
# QC global objects
qc_logfile <- file.path("logs", paste0("qc_pct_", format(Sys.time(), "%Y%m%d_%H%M"), ".txt"))
qc_events <- list()
qc_start_time <- Sys.time()

# Centralized Quality Control (QC) Log
log_qc <- function(msg, level = c("INFO", "WARN", "FAIL"), step = NULL, logfile = qc_logfile) {
  # Create log message with time stamp and process level
  level <- match.arg(level)
  timestamp <- format(Sys.time(), "%Y-%m-%d %H:%M")
  prefix <- paste0("[",level,"]")
  if (!is.null(step)) {
    prefix <- paste0(prefix, " (", step, ")")
  }
  full_msg <- paste(prefix, msg)
  
  # Wrap to console width
  wrapped_msg <- paste(strwrap(full_msg, width = getOption("width")), collapse = "\n")

  # Save to global qc_events
  qc_events[[length(qc_events) + 1]] <<- list(
    level = level, step = step, msg = msg, timestamp = timestamp)

  # Print 3 types of QC output to console
  if (level == "INFO") message(full_msg)
  if (level == "WARN") warning(full_msg, call. = FALSE)
  if (level == "FAIL") {
    message(full_msg)
    # Show summary up to this point before stopping
    summarize_qc(qc_events, Final = FALSE, start_time = qc_start_time)
    stop(full_msg, call. = FALSE)
  }

  # Append console output to logfile
  cat(full_msg, file = logfile, append = TRUE, sep = "\n")
}

# Print Initial message
log_qc("ℹ️ QC system initialized for PCT forecasting", "INFO", "Init")

# Summarize QC results
summarize_qc <- function(events, Final = TRUE, logfile = qc_logfile, start_time = qc_start_time) {
  if (length(events) == 0) {
    msg <- "No QC events logged."
    message(msg)
    cat(msg, file = logfile, append = TRUE, sep = "\n")
    return(invisible(NULL))
  }
  
  # Count events by level (always INFO, WARN, FAIL)
  levels <- c("INFO", "WARN", "FAIL")
  counts <- table(factor(vapply(events, function(e) e$level, character(1)), levels = levels))

  # Calculate run time
  runtime <- as.numeric(difftime(Sys.time(), start_time, units = "secs"))
  runtime_fmt <- if (runtime < 60) sprintf("%.1f seconds", runtime) else if (runtime < 3600) sprintf("%.1f minutes", runtime/60) else sprintf("%.2f hours", runtime/3600)
  
  # Build QC summary line
  summary_msg <- paste(
    if (Final) "QC Run Summary (Final):" else "QC Run Summary (so far):",
    paste(names(counts), counts, collapse = " | "),
    "| Runtime:", runtime_fmt)
  
  # Print QC summary lines in log
  message(summary_msg)
  cat(summary_msg, file = logfile, append = TRUE, sep = "\n")
  
  # Show WARN/FAIL details
  warn_fail <- Filter(function(e) e$level %in% c("WARN", "FAIL"), events)
  if (length(warn_fail) > 0) {
    msg <- "Warnings/Failures:"
    message(msg)
    cat(msg, file = logfile, append = TRUE, sep = "\n")
    for (e in warn_fail) {
      detail <- paste(" - [", e$level, "] (", e$step, ") ", e$msg, sep = "")
      message(detail)
      cat(detail, file = logfile, append = TRUE, sep = "\n")
    }
  } else {
    msg <- "No warnings or failures. ✅ All checks passed!"
    message(msg)
    cat(msg, file = logfile, append = TRUE, sep = "\n")
  }
}

# Outlier QC function 
# Hybrid rule = absolute value greater than threshold AND percent difference greater than threshold
# Comparing 2024 -> 2025
# NOTE, 3750 TOTAL forecasts = 75 forecasts for 50 colleges; 
# This QC includes 12 ETS forecasts and 63 PCT forecasts for determining overall outlier count.

check_forecast_outliers <- function(historical,
                                    forecast,
                                    abs_threshold = 20,
                                    pct_threshold = 0.25,
                                    min_val = 50,
                                    logfun = log_qc,
                                    export_missing = TRUE) {
  # historical: full historical dataset (contains Year)
  # forecast: full forecast dataset (contains Year)
  # abs_threshold: absolute difference threshold (same units as variables)
  # pct_threshold: relative difference threshold (fraction, e.g. 0.25 = 25%)
  # min_val: require either forecast or historical to be >= min_val for outlier to count
  # logfun: function for logging QC information (log_qc)
  # export_missing: if TRUE, export a diagnostic listing missing (college,variable) comparisons

  # Helper function for WARN messages that prints immediately
  log_warn_immediate <- function(msg) {
    logfun(msg, "WARN", "Outlier QC")
    message(sprintf("[WARN] (Outlier QC) %s", msg))
  }
  
  # Identify forecast columns (exclude ids/index columns)
  forecast_vars <- setdiff(names(forecast), c("FICE", "Institution", "Year", "Type"))
  if (length(forecast_vars) == 0) {
    logfun("❌ No forecast variables detected (nothing to compare).", "FAIL", "Outlier QC")
    return(tibble()) 
  }

  # Subset 2024 historicals and 2025 forecasts
  hist_2024 <- historical %>%
    filter(Year == 2024) %>%
    select(FICE, Institution, all_of(forecast_vars))

  fcst_2025 <- forecast %>%
    filter(Year == 2025) %>%
    select(FICE, Institution, all_of(forecast_vars))

  # Pivot to long for easy comparison
  hist_long <- hist_2024 %>%
    pivot_longer(cols = -c(FICE, Institution), names_to = "Variable", values_to = "Value_2024")

  fc_long <- fcst_2025 %>%
    pivot_longer(cols = -c(FICE, Institution), names_to = "Variable", values_to = "Forecast")

  # Join forecasts to historicals (left join on forecasts)
  comp <- left_join(fc_long, hist_long, by = c("FICE", "Institution", "Variable"))

  # Robust numeric conversion & diffs
  comp <- comp %>%
    mutate(
      Forecast_num = suppressWarnings(as.numeric(Forecast)),
      Value2024_num = suppressWarnings(as.numeric(Value_2024)),
      # compute diffs using numeric versions
      abs_diff = abs(Forecast_num - Value2024_num),
      denom = ifelse(is.na(Value2024_num) | Value2024_num == 0, 1, abs(Value2024_num)),
      pct_diff = pmin(abs_diff / denom, 1.00)  # cap at 100%
    )

  # Diagnostic counts before filtering
  n_before <- nrow(comp)

  # ENFORCE min_val as a hard pre-filter
  # Keep rows only if at least one side is >= min_val (this removes rows where BOTH < min_val)
  comp_filtered <- comp %>%
    filter(!is.na(Forecast_num) & !is.na(Value2024_num)) %>%
    filter(Forecast_num >= min_val | Value2024_num >= min_val)


  n_after_minval <- nrow(comp_filtered)
  n_removed_by_minval <- n_before - n_after_minval

  # Log how many rows were removed by min_val (helpful diagnostic)
  logfun(sprintf("ℹ️ %d rows removed because both Forecast and 2024 < %d (min_val).",
                 n_removed_by_minval, min_val),
         "INFO", "Outlier QC")

  # Apply threshold rule to the (already min_val-filtered) set
  outliers_df <- comp_filtered %>%
    filter(abs_diff > abs_threshold & pct_diff > pct_threshold)

  # Diagnostics: Expected comparisons (institutions * variables) vs actual rows available to compare
  inst_union <- sort(unique(c(unique(fc_long$FICE), unique(hist_long$FICE))))
  expected_total <- length(inst_union) * length(forecast_vars)

  # Use the number of rows actually used for threshold testing (comp_filtered)
  actual_comp_rows <- n_after_minval

  # Percent of outliers relative to actual comparisons used
  outlier_pct <- if (actual_comp_rows > 0) nrow(outliers_df) / actual_comp_rows else 0

  # Compute % outliers relative to the ENTIRE dataset (before any filtering)
  outlier_pct_total <- if (n_before > 0) nrow(outliers_df) / n_before else 0

  # Log the main QC message (WARN if >5% otherwise INFO)
  msg_text <- sprintf(
    "ℹ️ %d out of %d ETS & PCT forecasts (%.1f%%) exceed both %d absolute and %.0f%% relative difference from 2024 values.",
    nrow(outliers_df), n_before, 100 * outlier_pct_total, abs_threshold, 100 * pct_threshold
  )

  if(outlier_pct_total > 0.05) {
    log_warn_immediate(msg_text)   # prints immediately
  } else {
    logfun(msg_text, "INFO", "Outlier QC")  # normal INFO logging
  }

  # If actual comparisons differ from expected, export a small diagnostic and log it
  if (n_before != expected_total) {
    diag_msg <- sprintf(
      "❌ Expected %d comparisons (institutions * vars) but have %d joined rows to compare. Missing: %d.",
      expected_total, n_before, expected_total - n_before)
    logfun(diag_msg, "INFO", "Outlier QC")

    if (export_missing) {
      all_pairs <- expand_grid(FICE = inst_union, Variable = forecast_vars)
      present_pairs <- comp %>% distinct(FICE, Variable)
      missing_pairs <- anti_join(all_pairs, present_pairs, by = c("FICE", "Variable"))
      write.xlsx(missing_pairs, file = "final-forecasts/fy25-official-outlier-missing-diagnostic.xlsx", overwrite = TRUE)
      logfun("✅ Exported missing-comparisons diagnostic to final-forecasts/fy25-official-outlier-missing-diagnostic.xlsx", "INFO", "Outlier QC")
    }
  }

  # Return the outliers in the shape downstream code expects
  out_final <- outliers_df %>%
    transmute(FICE, Institution, Variable, Forecast = Forecast_num, Value_2024 = Value2024_num, abs_diff, pct_diff)

  invisible(out_final)
}

# Function to check that all required variable names exist in a dataset
check_required_vars <- function(data, required_vars, context = "Unknown", stop_on_missing = TRUE) {
  missing_vars <- setdiff(required_vars, names(data))
  if (length(missing_vars) > 0) {
    msg <- paste0(
      "❌ Missing or misspelled variables detected in ", context, ": ",
      paste(missing_vars, collapse = ", ")
    )
    log_qc(msg, "FAIL", context)
    if (stop_on_missing) stop(msg, call. = FALSE)
  } else {
    log_qc(
      paste0("✅ All required variables found for ", context, " (n=", length(required_vars), ")."),
      "INFO", context
    )
  }
}

```

## Import and Transform Data
* 50 rows expected (one per institution)
* 79 columns expected (4 ID columns + 75 variables)
```{r import_transform}
log_qc(paste("ℹ️ Reading data file:", params$merged_data), "INFO", "Import")

# Read in historical data
data <- read.xlsx(params$merged_data)

# QC: Check data dimensions
log_qc(paste("✅ Data file found:", params$merged_data, "; raw data dimensions:", paste(dim(data), collapse = " x ")), "INFO", "Import")

# Create new object for data transformation
data_transformed <- data

# Select relevant columns for ICLC, OSA student subgroups, OSA summaries
# ICLC columns (by name pattern)
iclc_cols <- names(data_transformed %>% select(FICE, Institution, Year, contains("Institutional")))

# OSA subgroup columns (must contain OSA and "...")
osa_subgroup_cols <- names(data_transformed %>% select(FICE, Institution, Year, matches("OSA.*\\.\\.\\.")))

# TOTAL OSA, OSA, and OSA HDF
osa_summary_cols <- names(data_transformed %>% select(FICE, Institution, Year, TOTAL.OSA, OSA, OSA..High.Demand.Field))

# Create isolated data subsets
iclc <- data_transformed[, iclc_cols]
osa_subgroup <- data_transformed[, osa_subgroup_cols]
osa_summary <- data_transformed[, osa_summary_cols]

# Define ID columns
id_cols <- c("FICE", "Institution", "Year")

# Remove only the non-ID columns from main data
remove_cols <- setdiff(c(iclc_cols, osa_subgroup_cols, osa_summary_cols), id_cols)
data_transformed <- data_transformed[, !(names(data_transformed) %in% remove_cols)]

# Helper function to filter years and selectively replace 0s with NA
filter_years_na <- function(df, years) {
  df %>%
    filter(Year %in% years) %>%
    mutate(across(where(is.numeric), ~na_if(., 0)))
}

# Create filtered datasets for years that need 0s replaced with NA
# ICLC NAs = 2018-2019
# OSA student subgroup NAs = 2018-2022
# OSA summary column NAs (TOTAL OSA, OSA, OSA HDF) = 2018-2019
iclc1819 <- filter_years_na(iclc, c(2018, 2019))
osa_subgroup1822 <- filter_years_na(osa_subgroup, 2018:2022)
osa_summary1819 <- filter_years_na(osa_summary, c(2018, 2019))

# Remove filtered years from full data sets
iclc <- iclc %>% 
  filter(!Year %in% c(2018, 2019))
osa_subgroup <- osa_subgroup %>% 
  filter(!Year %in% c(2018:2022))
osa_summary <- osa_summary %>% 
  filter(!Year %in% c(2018, 2019))

# Add converted NA data back into full data sets
iclc <- bind_rows(iclc, iclc1819)
osa_subgroup <- bind_rows(osa_subgroup, osa_subgroup1822)
osa_summary <- bind_rows(osa_summary, osa_summary1819)

# Merge transformed OSA, ICLC columns back into main data set
data_transformed <- data_transformed %>%
  left_join(iclc, by = c("FICE", "Institution", "Year")) %>%
  left_join(osa_subgroup, by = c("FICE", "Institution", "Year")) %>%
  left_join(osa_summary, by = c("FICE", "Institution", "Year"))

# Relocate columns to original place
data_transformed <- data_transformed %>%
  relocate(contains("Institutional"), .after = `GAI.Co.enrollment.with.15.SCH...Adult.Learner`) %>%
  relocate(contains("TOTAL.OSA"), .after = `Institutional.Credential.leading.to.Licensure..High.Demand.Field`) %>%
  relocate(TOTAL.OSA, .before = TOTAL.OSA...Academic.Disadvantage) %>%
  relocate(starts_with("OSA"), .after = `TOTAL.OSA...Adult.Learner`) %>% 
  relocate(TOTAL.OSA, .before = TOTAL.OSA...Academic.Disadvantage) %>% 
  relocate(c(OSA, 
             `OSA...Academic.Disadvantage`, 
             `OSA...Economic.Disadvantage`, 
             `OSA...Adult.Learner`, 
             `OSA..High.Demand.Field`, 
             `OSA..High.Demand.Field...Academic.Disadvantage`, 
             `OSA..High.Demand.Field...Economic.Disadvantage`, 
             `OSA..High.Demand.Field...Adult.Learner`), 
           .after = `TOTAL.OSA...Adult.Learner`)

# QC: Check that data_transformed dimensions (rows and columns) match data dimensions
if (nrow(data_transformed) != nrow(data)) {
  log_qc("❌ Row count mismatch after transformation. Please investigate.", "FAIL", "Transform")
} else {
  log_qc("✅ Transformed data row count matches raw data after transformation.", "INFO", "Transform")
}
if (ncol(data_transformed) != ncol(data)) {
  log_qc("❌ Column count mismatch after transformation. Please investigate.", "FAIL", "Transform")
} else {
  log_qc("✅ Transformed data column count matches raw data after transformation.", "INFO", "Transform")
}

```

## Export Transformed OSA & ICLC Data
```{r transform_export}
# Export transformed data
out_transformed <- "data/2018-2024-osa-iclc-transformed.xlsx"
write.xlsx(data_transformed, out_transformed)

if (file.exists(out_transformed)) {
  log_qc(paste("✅ Exported transformed data to", out_transformed), "INFO", "Export")
} else {
  log_qc(paste("❌ Export failed for", out_transformed), "FAIL", "Export")
}

# Now you can proceed with calculating average annual percentages without deflation from false 0s
```

## PCT QC Checks
```{r pct_qc_viz}

# QC: Confirm 50 observations of data for each historical year
qc_check <- data_transformed %>%
  count(Year, name = "n_obs") %>%
  mutate(status = if_else(n_obs < 50, "FAIL", "INFO"))

# Log results for each year
qc_check %>%
  rowwise() %>%
  mutate(msg = paste0("Year ", Year, ": ", n_obs, " rows")) %>%
  mutate(dummy = log_qc("ℹ️ Historical data row check", status, msg)) %>%
  invisible()

# Remove ETS forecast variables for data visualization simplicity
data_pct <- data_transformed %>% 
  select(-c(X15.SCH.Dual.Credit, GAI.Transfer.with.15.SCH, GAI.Co.enrollment.with.15.SCH, TOTAL.Institutional.Credential.leading.to.Licensure, TOTAL.OSA, TOTAL.Certificate.I.or.II, TOTAL.Advanced.Technical.Certificate, TOTAL.Associate.Degree, TOTAL.Bachelor.s.Degree, TOTAL.Certificate.I.or.II..COV.Premium, TOTAL.Associate..CoV.Premium, TOTAL.Bachelor.s.Degree..CoV.Premium))

# QC: Create table and graph for number and percentage data missing by column
missing_df <- tibble(
  variable = names(data_pct),
  missing = colSums(is.na(data_pct))) %>%
  mutate(
    pct_missing = round(missing / nrow(data_pct) * 100, 0),
    pct_missing = paste0(pct_missing, "%")) %>%
  arrange(desc(missing))

  # Show top missing columns
  kable(head(missing_df, 20), 
        caption = "QC: Top 20 PCT Forecast Columns by Missingness",
        align = c("l", "c", "c")) # left for cols 1, center for 2-3


# QC: Log how many variables have >20% missingness
num_high_missing <- sum(as.numeric(sub("%", "", missing_df$pct_missing)) > 20)
log_qc(paste("ℹ️ Variables with >20% missingness:", num_high_missing), 
       "INFO", "Missing Data QC")

```

## Confirm Variables Exist for Historical Percentage Formulae
```{r check_vars}
# Define required variables for historical percentage calculations
# All variables required for the "Create Historical Percentage Columns" step
required_vars_newcols <- c(
  # --- GAI: Transfer with 15 SCH ---
  "GAI.Transfer.with.15.SCH...Academic.Disadvantage",
  "GAI.Transfer.with.15.SCH...Economic.Disadvantage",
  "GAI.Transfer.with.15.SCH...Adult.Learner",
  "GAI.Transfer.with.15.SCH",
  
  # --- GAI: Co-enrollment with 15 SCH ---
  "GAI.Co.enrollment.with.15.SCH..Academic.Disadvantage",
  "GAI.Co.enrollment.with.15.SCH...Economic.Disadvantage",
  "GAI.Co.enrollment.with.15.SCH...Adult.Learner",
  "GAI.Co.enrollment.with.15.SCH",
  
  # --- Institutional Credential Leading to Licensure (ICLC) ---
  "Institutional.Credential.leading.to.Licensure",
  "Institutional.Credential.leading.to.Licensure..High.Demand.Field",
  "TOTAL.Institutional.Credential.leading.to.Licensure",
  
  # --- Occupational Skills Award (OSA) ---
  "TOTAL.OSA",
  "TOTAL.OSA...Academic.Disadvantage",
  "TOTAL.OSA...Economic.Disadvantage",
  "TOTAL.OSA...Adult.Learner",
  
  "OSA",
  "OSA...Academic.Disadvantage",
  "OSA...Economic.Disadvantage",
  "OSA...Adult.Learner",
  "OSA..High.Demand.Field",
  "OSA..High.Demand.Field...Academic.Disadvantage",
  "OSA..High.Demand.Field...Economic.Disadvantage",
  "OSA..High.Demand.Field...Adult.Learner",
  
  # --- Certificate I or II ---
  "TOTAL.Certificate.I.or.II",
  "TOTAL.Certificate.I.or.II...Academic.Disadvantage",
  "TOTAL.Certificate.I.or.II...Economic.Disadvantage",
  "TOTAL.Certificate.I.or.II...Adult.Learner",
  "Certificate.I.or.II",
  "Certificate.I.or.II...Academic.Disadvantage",
  "Certificate.I.or.II...Economic.Disadvantage",
  "Certificate.I.or.II...Adult.Learner",
  "Certificate.I.or.II..High.Demand.Field",
  "Certificate.I.or.II..High.Demand.Field...Academic.Disadvantage",
  "Certificate.I.or.II..High.Demand.Field...Economic.Disadvantage",
  "Certificate.I.or.II..High.Demand.Field...Adult.Learner",
  
  # --- Advanced Technical Certificate (ATC) ---
  "TOTAL.Advanced.Technical.Certificate",
  "TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage",
  "TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage",
  "TOTAL.Advanced.Technical.Certificate...Adult.Learner",
  "Advanced.Technical.Certificate",
  "Advanced.Technical.Certificate...Academic.Disadvantage",
  "Advanced.Technical.Certificate...Economic.Disadvantage",
  "Advanced.Technical.Certificate...Adult.Learner",
  "Advanced.Technical.Certificate..High.Demand.Field",
  "Advanced.Technical.Certificate..High.Demand.Field...Academic.Disadvantage",
  "Advanced.Technical.Certificate..High.Demand.Field...Economic.Disadvantage",
  "Advanced.Technical.Certificate..High.Demand.Field...Adult.Learner",
  
  # --- Associate Degree ---
  "TOTAL.Associate.Degree",
  "TOTAL.Associate.Degree...Academic.Disadvantage",
  "TOTAL.Associate.Degree...Economic.Disadvantage",
  "TOTAL.Associate.Degree...Adult.Learner",
  "Associate.Degree",
  "Associate.Degree...Academic.Disadvantage",
  "Associate.Degree...Economic.Disadvantage",
  "Associate.Degree...Adult.Learner",
  "Associate.Degree..High.Demand.Field",
  "Associate.Degree..High.Demand.Field...Academic.Disadvantage",
  "Associate.Degree..High.Demand.Field...Economic.Disadvantage",
  "Associate.Degree..High.Demand.Field...Adult.Learner",
  
  # --- Bachelor's Degree ---
  "TOTAL.Bachelor.s.Degree",
  "TOTAL.Bachelor.s.Degree...Academic.Disadvantage",
  "TOTAL.Bachelor.s.Degree...Economic.Disadvantage",
  "TOTAL.Bachelor.s.Degree...Adult.Learner",
  "Bachelor.s.Degree",
  "Bachelor.s.Degree...Academic.Disadvantage",
  "Bachelor.s.Degree...Economic.Disadvantage",
  "Bachelor.s.Degree...Adult.Learner",
  "Bachelor.s.Degree..High.Demand.Field",
  "Bachelor.s.Degree..High.Demand.Field...Academic.Disadvantage",
  "Bachelor.s.Degree..High.Demand.Field...Economic.Disadvantage",
  "Bachelor.s.Degree..High.Demand.Field...Adult.Learner"
)

# QC check: verify all required variables exist before calculations
check_required_vars(data_transformed, required_vars_newcols, context = "Create Pcts")

```

## Create Historical Percentage Columns
* 63 new columns should be created

```{r new_cols}

log_qc("ℹ️ Creating historical percentage (pct) variables.", "INFO", "Create Pcts")

# Track column count before new column creation
before_cols <- ncol(data_transformed)

# Create historical average columns for 63 variables not forecast with ETS
# The columns labeled with "(%)" represent the historical percentage of each subgroup within the total credential category, 
# averaged over 2018–2024 (or fewer years if no data collection in relevant years). 
# These values are applied to the ETS forecasts to estimate subgroup outcomes.

pct <- data_transformed %>% 
  mutate("GAI Transfer-acadis-pct" = `GAI.Transfer.with.15.SCH...Academic.Disadvantage`/GAI.Transfer.with.15.SCH,
         "GAI Transfer-ecodis-pct" = `GAI.Transfer.with.15.SCH...Economic.Disadvantage`/GAI.Transfer.with.15.SCH,
         "GAI Transfer-adult-pct" = `GAI.Transfer.with.15.SCH...Adult.Learner`/GAI.Transfer.with.15.SCH,
         "GAI Co-enroll-acadis-pct" = `GAI.Co.enrollment.with.15.SCH..Academic.Disadvantage`/`GAI.Co.enrollment.with.15.SCH`,
         "GAI Co-enroll-ecodis-pct" = `GAI.Co.enrollment.with.15.SCH...Economic.Disadvantage`/`GAI.Co.enrollment.with.15.SCH`,
         "GAI Co-enroll-adult-pct" = `GAI.Co.enrollment.with.15.SCH...Adult.Learner`/`GAI.Co.enrollment.with.15.SCH`,
         "ICLC-pct" = Institutional.Credential.leading.to.Licensure/TOTAL.Institutional.Credential.leading.to.Licensure,
         "ICLC-HDF-pct" = `Institutional.Credential.leading.to.Licensure..High.Demand.Field`/TOTAL.Institutional.Credential.leading.to.Licensure,
         "TOTAL OSA-acadis-pct" = `TOTAL.OSA...Academic.Disadvantage`/TOTAL.OSA,
         "TOTAL OSA-ecodis-pct" = `TOTAL.OSA...Economic.Disadvantage`/TOTAL.OSA,
         "TOTAL OSA-adult-pct" = `TOTAL.OSA...Adult.Learner`/TOTAL.OSA,
         "OSA-pct" = OSA/TOTAL.OSA,
         "OSA-acadis-pct" = `OSA...Academic.Disadvantage`/`TOTAL.OSA...Academic.Disadvantage`,
         "OSA-ecodis-pct" = `OSA...Economic.Disadvantage`/`TOTAL.OSA...Economic.Disadvantage`,
         "OSA-adult-pct" = `OSA...Adult.Learner`/`TOTAL.OSA...Adult.Learner`,
         "OSA-HDF-pct" = `OSA..High.Demand.Field`/TOTAL.OSA,
         "OSA-HDF-acadis-pct" = `OSA..High.Demand.Field...Academic.Disadvantage`/`TOTAL.OSA...Academic.Disadvantage`,
         "OSA-HDF-ecodis-pct" = `OSA..High.Demand.Field...Economic.Disadvantage`/`TOTAL.OSA...Economic.Disadvantage`,
         "OSA-HDF-adult-pct" = `OSA..High.Demand.Field...Adult.Learner`/`TOTAL.OSA...Adult.Learner`,
         "TOTAL Cert-acadis-pct" = `TOTAL.Certificate.I.or.II...Academic.Disadvantage`/TOTAL.Certificate.I.or.II,
         "TOTAL Cert-ecodis-pct" = `TOTAL.Certificate.I.or.II...Economic.Disadvantage`/TOTAL.Certificate.I.or.II,
         "TOTAL Cert-adult-pct" = `TOTAL.Certificate.I.or.II...Adult.Learner`/TOTAL.Certificate.I.or.II,
         "Cert-pct" = Certificate.I.or.II/TOTAL.Certificate.I.or.II,
         "Cert-acadis-pct" = `Certificate.I.or.II...Academic.Disadvantage`/`TOTAL.Certificate.I.or.II...Academic.Disadvantage`,
         "Cert-ecodis-pct" = `Certificate.I.or.II...Economic.Disadvantage`/`TOTAL.Certificate.I.or.II...Economic.Disadvantage`,
         "Cert-adult-pct" = `Certificate.I.or.II...Adult.Learner`/`TOTAL.Certificate.I.or.II...Adult.Learner`,
         "Cert-HDF-pct" = `Certificate.I.or.II..High.Demand.Field`/TOTAL.Certificate.I.or.II,
         "Cert-HDF-acadis-pct" = `Certificate.I.or.II..High.Demand.Field...Academic.Disadvantage`/`TOTAL.Certificate.I.or.II...Academic.Disadvantage`,
         "Cert-HDF-ecodis-pct" = `Certificate.I.or.II..High.Demand.Field...Economic.Disadvantage`/`TOTAL.Certificate.I.or.II...Economic.Disadvantage`,
         "Cert-HDF-adult-pct" = `Certificate.I.or.II..High.Demand.Field...Adult.Learner`/`TOTAL.Certificate.I.or.II...Adult.Learner`,
         "TOTAL ATC-acadis-pct" = `TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage`/TOTAL.Advanced.Technical.Certificate,
         "TOTAL ATC-ecodis-pct" = `TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage`/TOTAL.Advanced.Technical.Certificate,
         "TOTAL ATC-adult-pct" = `TOTAL.Advanced.Technical.Certificate...Adult.Learner`/TOTAL.Advanced.Technical.Certificate,
         "ATC-pct" = Advanced.Technical.Certificate/TOTAL.Advanced.Technical.Certificate,
         "ATC-acadis-pct" = `Advanced.Technical.Certificate...Academic.Disadvantage`/`TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage`,
         "ATC-ecodis-pct" = `Advanced.Technical.Certificate...Economic.Disadvantage`/`TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage`,
         "ATC-adult-pct" = `Advanced.Technical.Certificate...Adult.Learner`/`TOTAL.Advanced.Technical.Certificate...Adult.Learner`,
         "ATC-HDF-pct" = `Advanced.Technical.Certificate..High.Demand.Field`/TOTAL.Advanced.Technical.Certificate,
         "ATC-HDF-acadis-pct" = `Advanced.Technical.Certificate..High.Demand.Field...Academic.Disadvantage`/`TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage`,
         "ATC-HDF-ecodis-pct" = `Advanced.Technical.Certificate..High.Demand.Field...Economic.Disadvantage`/`TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage`,
         "ATC-HDF-adult-pct" = `Advanced.Technical.Certificate..High.Demand.Field...Adult.Learner`/`TOTAL.Advanced.Technical.Certificate...Adult.Learner`,
         "TOTAL Assoc-acadis-pct" = `TOTAL.Associate.Degree...Academic.Disadvantage`/TOTAL.Associate.Degree,
         "TOTAL Assoc-ecodis-pct" = `TOTAL.Associate.Degree...Economic.Disadvantage`/TOTAL.Associate.Degree,
         "TOTAL Assoc-adult-pct" = `TOTAL.Associate.Degree...Adult.Learner`/TOTAL.Associate.Degree,
         "Assoc-pct" = Associate.Degree/TOTAL.Associate.Degree,
         "Assoc-acadis-pct" = `Associate.Degree...Academic.Disadvantage`/`TOTAL.Associate.Degree...Academic.Disadvantage`,
         "Assoc-ecodis-pct" = `Associate.Degree...Economic.Disadvantage`/`TOTAL.Associate.Degree...Economic.Disadvantage`,
         "Assoc-adult-pct" = `Associate.Degree...Adult.Learner`/`TOTAL.Associate.Degree...Adult.Learner`,
         "Assoc-HDF-pct" = `Associate.Degree..High.Demand.Field`/TOTAL.Associate.Degree,
         "Assoc-HDF-acadis-pct" = `Associate.Degree..High.Demand.Field...Academic.Disadvantage`/`TOTAL.Associate.Degree...Academic.Disadvantage`,
         "Assoc-HDF-ecodis-pct" = `Associate.Degree..High.Demand.Field...Economic.Disadvantage`/`TOTAL.Associate.Degree...Economic.Disadvantage`,
         "Assoc-HDF-adult-pct" = `Associate.Degree..High.Demand.Field...Adult.Learner`/`TOTAL.Associate.Degree...Adult.Learner`,
         "TOTAL Bach-acadis-pct" = `TOTAL.Bachelor.s.Degree...Academic.Disadvantage`/`TOTAL.Bachelor.s.Degree`,
         "TOTAL Bach-ecodis-pct" = `TOTAL.Bachelor.s.Degree...Economic.Disadvantage`/`TOTAL.Bachelor.s.Degree`,
         "TOTAL Bach-adult-pct" = `TOTAL.Bachelor.s.Degree...Adult.Learner`/`TOTAL.Bachelor.s.Degree`,
         "Bach-pct" = `Bachelor.s.Degree`/`TOTAL.Bachelor.s.Degree`,
         "Bach-acadis-pct" = `Bachelor.s.Degree...Academic.Disadvantage`/`TOTAL.Bachelor.s.Degree...Academic.Disadvantage`,
         "Bach-ecodis-pct" = `Bachelor.s.Degree...Economic.Disadvantage`/`TOTAL.Bachelor.s.Degree...Economic.Disadvantage`,
         "Bach-adult-pct" = `Bachelor.s.Degree...Adult.Learner`/`TOTAL.Bachelor.s.Degree...Adult.Learner`,
         "Bach-HDF-pct" = `Bachelor.s.Degree..High.Demand.Field`/`TOTAL.Bachelor.s.Degree`,
         "Bach-HDF-acadis-pct" = `Bachelor.s.Degree..High.Demand.Field...Academic.Disadvantage`/`TOTAL.Bachelor.s.Degree...Academic.Disadvantage`,
         "Bach-HDF-ecodis-pct" = `Bachelor.s.Degree..High.Demand.Field...Economic.Disadvantage`/`TOTAL.Bachelor.s.Degree...Economic.Disadvantage`,
         "Bach-HDF-adult-pct" = `Bachelor.s.Degree..High.Demand.Field...Adult.Learner`/`TOTAL.Bachelor.s.Degree...Adult.Learner`)

# Track column count after
after_cols <- ncol(pct)
new_cols <- after_cols - before_cols

# QC log message
if (new_cols == 63) {
  log_qc(
    sprintf("✅ Successfully created %d new pct columns.", new_cols),
    "INFO", "Create Pcts"
  )
} else {
  log_qc(
    "❌ No new pct columns were created — check mutate step.",
    "WARN", "Create Pcts"
  )
}
```

## Clean and Transform Historical Percentages
```{r transform_avgs}

# Compute average historical subgroup percentages for each institution
pct2 <- pct %>%
  # Keep only ID and percentage columns
  select(FICE, Institution, Year, contains("-pct")) %>%
  
  # Group by FICE (unique identifier for colleges)
  group_by(FICE) %>%
  
  # Calculate multi-year averages for all subgroup % columns
  summarise(
    across(
      .cols = -c(Institution, Year),     # apply to all percentage vars
      .fns  = ~ mean(.x, na.rm = TRUE),  # NA-safe mean
      .names = "{.col}"
    ),
    .groups = "drop"
  ) %>%
  
  # Add back Institution names (avoid spelling mismatches by joining from raw data)
  left_join(
    distinct(select(data_transformed, FICE, Institution)),
    by = "FICE"
  ) %>%
  
  # Place Institution column right after FICE
  relocate(Institution, .after = FICE)

# Convert subgroup averages with missing values to 0
pct2[is.na(pct2)] <- 0

## QC check: Verify averages match
# 1. Compute average across 2018-2024 in pct
pct_avg <- pct %>%
  group_by(FICE) %>%
  summarise(across(`GAI Transfer-acadis-pct`:`Bach-HDF-adult-pct`, ~mean(.x, na.rm = TRUE)))

# 2. Compare to pct2 (already has one averaged value per FICE)
qc_check <- pct_avg %>%
  left_join(pct2 %>% select(FICE, `GAI Transfer-acadis-pct`:`Bach-HDF-adult-pct`), by = "FICE", suffix = c("_avg", "_pct2")) %>%
  mutate(across(ends_with("_avg"), ~abs(. - get(sub("_avg$", "_pct2", cur_column()))), .names = "diff_{col}"))

# 3. Identify any discrepancies
diff_cols <- grep("^diff_", names(qc_check), value = TRUE)
qc_outliers <- qc_check %>%
  filter(if_any(all_of(diff_cols), ~.x > 1e-8))  # small tolerance for floating point

# 4. Log QC
if (nrow(qc_outliers) > 0) {
  log_qc(
    paste0("❌ Historical average QC failed for ", nrow(qc_outliers), " colleges. Check differences in averages vs pct2."),
    "WARN", "HistoricalAverageQC"
  )
} else {
  log_qc("✅ Historical average QC passed: pct averages match pct2.", "INFO", "HistoricalAverageQC")
}

```

## Export Historical Percentage Data
```{r export_avgs}
log_qc("ℹ️ Exporting historical average pct files to pct-averages/ folder.", "INFO", "Export")

# Export Average Historical Subgroup Percentages
write.xlsx(pct2, "pct-averages/fy25-avg-subgroup-pcts.xlsx")
# Export Annual Historical Subgroup Percentages 
write.xlsx(pct, "pct-averages/fy25-annual-subgroup-pcts.xlsx")

if (file.exists("pct-averages/fy25-avg-subgroup-pcts.xlsx") && file.exists("pct-averages/fy25-annual-subgroup-pcts.xlsx")) {
  log_qc("✅ Historical subgroup percentage files written successfully.", "INFO", "Export")
} else {
  log_qc("❌ Historical subgroup percentages export failed (one or both files missing).", "FAIL", "Export")
}

```

## Confirm Variables Exist for Apply Historical Averages Formulae
```{r check_vars2}
# List of all expected percentage columns created in the "Create Pcts" step
required_vars_pct2 <- c(
  # --- GAI Transfer ---
  "GAI Transfer-acadis-pct",
  "GAI Transfer-ecodis-pct",
  "GAI Transfer-adult-pct",
  
  # --- GAI Co-enrollment ---
  "GAI Co-enroll-acadis-pct",
  "GAI Co-enroll-ecodis-pct",
  "GAI Co-enroll-adult-pct",
  
  # --- ICLC ---
  "ICLC-pct",
  "ICLC-HDF-pct",
  
  # --- TOTAL OSA ---
  "TOTAL OSA-acadis-pct",
  "TOTAL OSA-ecodis-pct",
  "TOTAL OSA-adult-pct",
  
  # --- OSA ---
  "OSA-pct",
  "OSA-acadis-pct",
  "OSA-ecodis-pct",
  "OSA-adult-pct",
  "OSA-HDF-pct",
  "OSA-HDF-acadis-pct",
  "OSA-HDF-ecodis-pct",
  "OSA-HDF-adult-pct",
  
  # --- TOTAL Certificate I or II ---
  "TOTAL Cert-acadis-pct",
  "TOTAL Cert-ecodis-pct",
  "TOTAL Cert-adult-pct",
  
  # --- Certificate I or II ---
  "Cert-pct",
  "Cert-acadis-pct",
  "Cert-ecodis-pct",
  "Cert-adult-pct",
  "Cert-HDF-pct",
  "Cert-HDF-acadis-pct",
  "Cert-HDF-ecodis-pct",
  "Cert-HDF-adult-pct",
  
  # --- TOTAL Advanced Technical Certificate (ATC) ---
  "TOTAL ATC-acadis-pct",
  "TOTAL ATC-ecodis-pct",
  "TOTAL ATC-adult-pct",
  
  # --- Advanced Technical Certificate (ATC) ---
  "ATC-pct",
  "ATC-acadis-pct",
  "ATC-ecodis-pct",
  "ATC-adult-pct",
  "ATC-HDF-pct",
  "ATC-HDF-acadis-pct",
  "ATC-HDF-ecodis-pct",
  "ATC-HDF-adult-pct",
  
  # --- TOTAL Associate Degree ---
  "TOTAL Assoc-acadis-pct",
  "TOTAL Assoc-ecodis-pct",
  "TOTAL Assoc-adult-pct",
  
  # --- Associate Degree ---
  "Assoc-pct",
  "Assoc-acadis-pct",
  "Assoc-ecodis-pct",
  "Assoc-adult-pct",
  "Assoc-HDF-pct",
  "Assoc-HDF-acadis-pct",
  "Assoc-HDF-ecodis-pct",
  "Assoc-HDF-adult-pct",
  
  # --- TOTAL Bachelor’s Degree ---
  "TOTAL Bach-acadis-pct",
  "TOTAL Bach-ecodis-pct",
  "TOTAL Bach-adult-pct",
  
  # --- Bachelor’s Degree ---
  "Bach-pct",
  "Bach-acadis-pct",
  "Bach-ecodis-pct",
  "Bach-adult-pct",
  "Bach-HDF-pct",
  "Bach-HDF-acadis-pct",
  "Bach-HDF-ecodis-pct",
  "Bach-HDF-adult-pct"
)

# QC check before averaging percentages
check_required_vars(pct, required_vars_pct2, context = "Average Pcts")


```

## Apply Historical Average Percentages to Forecast Subgroup Outcomes
```{r apply_avgs}
log_qc("ℹ️ Applying historical averages to forecasts (begin).", "INFO", "Apply Pcts")

# Read in historical + forecast data for FY25
forecasts <- read.xlsx(params$forecasts)

log_qc(paste("✅ Successfully read forecasts file:", params$forecasts, "dims:", paste(dim(forecasts), collapse = " x ")), "INFO", "Apply Pcts")

# Convert all columns except FICE, Institution, and Type to numeric
forecasts <- forecasts %>%
  mutate(across(
    -c(FICE, Institution, Type),
    ~ as.numeric(.)
  ))

log_qc("ℹ️ Converted forecast columns to numeric where applicable.", "INFO", "Apply Pcts")

# Combine historical pcts with forecast output
data_pcts <- forecasts %>% 
  left_join(pct2[,c(1,3:65)] , by = "FICE")

# QC: check how many pct columns failed to join (NA count across pct columns)
pct_cols <- grep("pct", names(data_pcts), value = TRUE)
na_pct_total <- if (length(pct_cols)>0) sum(is.na(data_pcts[pct_cols])) else 0
log_qc(paste("ℹ️ After join, data_pcts dims:", paste(dim(data_pcts), collapse = " x "), "- total NA in pct cols:", na_pct_total), "INFO", "Apply Pcts")

# Apply transfer historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    `GAI.Transfer.with.15.SCH...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(`GAI.Transfer.with.15.SCH` * `GAI Transfer-acadis-pct`),
      `GAI.Transfer.with.15.SCH...Academic.Disadvantage`
    ),
    `GAI.Transfer.with.15.SCH...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(`GAI.Transfer.with.15.SCH` * `GAI Transfer-ecodis-pct`),
      `GAI.Transfer.with.15.SCH...Economic.Disadvantage`
    ),
    `GAI.Transfer.with.15.SCH...Adult.Learner` = if_else(
      Year == 2025,
      round(`GAI.Transfer.with.15.SCH` * `GAI Transfer-adult-pct`),
      `GAI.Transfer.with.15.SCH...Adult.Learner`))

log_qc("✅ Applied GAI transfer historical percentages.", "INFO", "Apply Pcts")

# Apply coenroll historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    `GAI.Co.enrollment.with.15.SCH..Academic.Disadvantage` = if_else(
      Year == 2025,
      round(`GAI.Co.enrollment.with.15.SCH` *  `GAI Co-enroll-acadis-pct`),
      `GAI.Co.enrollment.with.15.SCH..Academic.Disadvantage`
    ),
    `GAI.Co.enrollment.with.15.SCH...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(`GAI.Co.enrollment.with.15.SCH` * `GAI Co-enroll-ecodis-pct`),
      `GAI.Co.enrollment.with.15.SCH...Economic.Disadvantage`
    ),
    `GAI.Co.enrollment.with.15.SCH...Adult.Learner` = if_else(
      Year == 2025,
      round(`GAI.Co.enrollment.with.15.SCH` * `GAI Co-enroll-adult-pct`),
      `GAI.Co.enrollment.with.15.SCH...Adult.Learner`))

log_qc("✅ Applied GAI co-enrollment historical percentages.", "INFO", "Apply Pcts")

# Apply iclc historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    Institutional.Credential.leading.to.Licensure = if_else(
      Year == 2025,
      round(TOTAL.Institutional.Credential.leading.to.Licensure * `ICLC-pct`),
      Institutional.Credential.leading.to.Licensure
    ),
    `Institutional.Credential.leading.to.Licensure..High.Demand.Field` = if_else(
      Year == 2025,
      round(TOTAL.Institutional.Credential.leading.to.Licensure * `ICLC-HDF-pct`),
      `Institutional.Credential.leading.to.Licensure..High.Demand.Field`))

log_qc("✅ Applied ICLC historical percentages.", "INFO", "Apply Pcts")

# Apply osa historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    TOTAL.OSA...Academic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.OSA * `TOTAL OSA-acadis-pct`),
      TOTAL.OSA...Academic.Disadvantage
    ),
    TOTAL.OSA...Economic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.OSA * `TOTAL OSA-ecodis-pct`),
      TOTAL.OSA...Economic.Disadvantage
    ),
    TOTAL.OSA...Adult.Learner = if_else(
      Year == 2025,
      round(TOTAL.OSA * `TOTAL OSA-adult-pct`),
      TOTAL.OSA...Adult.Learner
    ),
    OSA = if_else(
      Year == 2025,
      round(TOTAL.OSA * `OSA-pct`),
      OSA
    ),
    `OSA...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.OSA...Academic.Disadvantage * `OSA-acadis-pct`),
      `OSA...Academic.Disadvantage`
    ),
    `OSA...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.OSA...Economic.Disadvantage * `OSA-ecodis-pct`),
      `OSA...Economic.Disadvantage`
    ),
    `OSA...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.OSA...Adult.Learner * `OSA-adult-pct`),
      `OSA...Adult.Learner`
    ),
    `OSA..High.Demand.Field` = if_else(
      Year == 2025,
      round(TOTAL.OSA * `OSA-HDF-pct`),
      `OSA..High.Demand.Field`
    ),
    `OSA..High.Demand.Field...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.OSA...Academic.Disadvantage * `OSA-HDF-acadis-pct`),
      `OSA..High.Demand.Field...Academic.Disadvantage`
    ),
    `OSA..High.Demand.Field...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.OSA...Economic.Disadvantage * `OSA-HDF-ecodis-pct`),
      `OSA..High.Demand.Field...Economic.Disadvantage`
    ),
    'OSA..High.Demand.Field...Adult.Learner' = if_else(
      Year == 2025,
      round(TOTAL.OSA...Adult.Learner * `OSA-HDF-adult-pct`),
      `OSA..High.Demand.Field...Adult.Learner`))

log_qc("✅ Applied OSA historical percentages.", "INFO", "Apply Pcts")
    
# Apply cert historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    TOTAL.Certificate.I.or.II...Academic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II * `TOTAL Cert-acadis-pct`),
      TOTAL.Certificate.I.or.II...Academic.Disadvantage
    ),
    TOTAL.Certificate.I.or.II...Economic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II * `TOTAL Cert-ecodis-pct`),
      TOTAL.Certificate.I.or.II...Economic.Disadvantage
    ),
    TOTAL.Certificate.I.or.II...Adult.Learner = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II * `TOTAL Cert-adult-pct`),
      TOTAL.Certificate.I.or.II...Adult.Learner
    ),
    Certificate.I.or.II = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II * `Cert-pct`),
      Certificate.I.or.II
    ),
    `Certificate.I.or.II...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Academic.Disadvantage * `Cert-acadis-pct`),
      `Certificate.I.or.II...Academic.Disadvantage`
    ),
    `Certificate.I.or.II...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Economic.Disadvantage * `Cert-ecodis-pct`),
      `Certificate.I.or.II...Economic.Disadvantage`
    ),
    `Certificate.I.or.II...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Adult.Learner * `Cert-adult-pct`),
      `Certificate.I.or.II...Adult.Learner`
    ),
    `Certificate.I.or.II..High.Demand.Field` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II * `Cert-HDF-pct`),
      `Certificate.I.or.II..High.Demand.Field`
    ),
    `Certificate.I.or.II..High.Demand.Field...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Academic.Disadvantage * `Cert-HDF-acadis-pct`),
      `Certificate.I.or.II..High.Demand.Field...Academic.Disadvantage`
    ), 
    `Certificate.I.or.II..High.Demand.Field...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Economic.Disadvantage * `Cert-HDF-ecodis-pct`),
      `Certificate.I.or.II..High.Demand.Field...Economic.Disadvantage`
    ),
    `Certificate.I.or.II..High.Demand.Field...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Certificate.I.or.II...Adult.Learner * `Cert-HDF-adult-pct`),
      `Certificate.I.or.II..High.Demand.Field...Adult.Learner`)) 

# Apply atc historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate * `TOTAL ATC-acadis-pct`),
      TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage
    ),
    TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate * `TOTAL ATC-ecodis-pct`),
      TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage
    ),
    TOTAL.Advanced.Technical.Certificate...Adult.Learner = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate * `TOTAL ATC-adult-pct`),
      TOTAL.Advanced.Technical.Certificate...Adult.Learner
    ),
    Advanced.Technical.Certificate = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate * `ATC-pct`),
      Advanced.Technical.Certificate
    ),
    `Advanced.Technical.Certificate...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage * `ATC-acadis-pct`),
      `Advanced.Technical.Certificate...Academic.Disadvantage`
    ),
    `Advanced.Technical.Certificate...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage * `ATC-ecodis-pct`),
      `Advanced.Technical.Certificate...Economic.Disadvantage`
    ),
    `Advanced.Technical.Certificate...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Adult.Learner * `ATC-adult-pct`),
      `Advanced.Technical.Certificate...Adult.Learner`
    ),
    `Advanced.Technical.Certificate..High.Demand.Field` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate * `ATC-HDF-pct`),
      `Advanced.Technical.Certificate..High.Demand.Field`
    ),
    `Advanced.Technical.Certificate..High.Demand.Field...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Academic.Disadvantage * `ATC-HDF-acadis-pct`),
      `Advanced.Technical.Certificate..High.Demand.Field...Academic.Disadvantage`
    ), 
    `Advanced.Technical.Certificate..High.Demand.Field...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Economic.Disadvantage * `ATC-HDF-ecodis-pct`),
      `Advanced.Technical.Certificate..High.Demand.Field...Economic.Disadvantage`
    ),
    `Advanced.Technical.Certificate..High.Demand.Field...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Advanced.Technical.Certificate...Adult.Learner * `ATC-HDF-adult-pct`),
      `Advanced.Technical.Certificate..High.Demand.Field...Adult.Learner`))

log_qc("✅ Applied Certificate historical percentages.", "INFO", "Apply Pcts")

# Apply assoc historical pcts
data_pcts <- data_pcts %>% 
  mutate(
    TOTAL.Associate.Degree...Academic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree * `TOTAL Assoc-acadis-pct`),
      TOTAL.Associate.Degree...Academic.Disadvantage
    ),
    TOTAL.Associate.Degree...Economic.Disadvantage = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree * `TOTAL Assoc-ecodis-pct`),
      TOTAL.Associate.Degree...Economic.Disadvantage
    ),
    TOTAL.Associate.Degree...Adult.Learner = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree * `TOTAL Assoc-adult-pct`),
      TOTAL.Associate.Degree...Adult.Learner
    ),
    Associate.Degree = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree * `Assoc-pct`),
      Associate.Degree
    ),
    `Associate.Degree...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Academic.Disadvantage * `Assoc-acadis-pct`),
      `Associate.Degree...Academic.Disadvantage`
    ),
    `Associate.Degree...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Economic.Disadvantage * `Assoc-ecodis-pct`),
      `Associate.Degree...Economic.Disadvantage`
    ),
    `Associate.Degree...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Adult.Learner * `Assoc-adult-pct`),
      `Associate.Degree...Adult.Learner`
    ),
    `Associate.Degree..High.Demand.Field` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree * `Assoc-HDF-pct`),
      `Associate.Degree..High.Demand.Field`
    ),
    `Associate.Degree..High.Demand.Field...Academic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Academic.Disadvantage * `Assoc-HDF-acadis-pct`),
      `Associate.Degree..High.Demand.Field...Academic.Disadvantage`
    ),
    `Associate.Degree..High.Demand.Field...Economic.Disadvantage` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Economic.Disadvantage * `Assoc-HDF-ecodis-pct`),
      `Associate.Degree..High.Demand.Field...Economic.Disadvantage`
    ),
    `Associate.Degree..High.Demand.Field...Adult.Learner` = if_else(
      Year == 2025,
      round(TOTAL.Associate.Degree...Adult.Learner * `Assoc-HDF-adult-pct`),
      `Associate.Degree..High.Demand.Field...Adult.Learner`))

log_qc("✅ Applied Associate Degree historical percentages.", "INFO", "Apply Pcts")

# Apply bachelor historical pcts
  data_pcts <- data_pcts %>% 
  mutate(
      TOTAL.Bachelor.s.Degree...Academic.Disadvantage = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree * `TOTAL Bach-acadis-pct`),
        TOTAL.Bachelor.s.Degree...Academic.Disadvantage
      ),
      TOTAL.Bachelor.s.Degree...Economic.Disadvantage = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree * `TOTAL Bach-ecodis-pct`),
        TOTAL.Bachelor.s.Degree...Economic.Disadvantage
      ),
      TOTAL.Bachelor.s.Degree...Adult.Learner = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree * `TOTAL Bach-adult-pct`),
        TOTAL.Bachelor.s.Degree...Adult.Learner
      ),
      Bachelor.s.Degree = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree * `Bach-pct`),
        Bachelor.s.Degree
      ),
      `Bachelor.s.Degree...Academic.Disadvantage` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Academic.Disadvantage * `Bach-acadis-pct`),
        `Bachelor.s.Degree...Academic.Disadvantage`
      ),
      `Bachelor.s.Degree...Economic.Disadvantage` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Economic.Disadvantage * `Bach-ecodis-pct`),
        `Bachelor.s.Degree...Economic.Disadvantage`
      ),
      `Bachelor.s.Degree...Adult.Learner` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Adult.Learner * `Bach-adult-pct`),
        `Bachelor.s.Degree...Adult.Learner`
      ),
      `Bachelor.s.Degree..High.Demand.Field` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree * `Bach-HDF-pct`),
        `Bachelor.s.Degree..High.Demand.Field`
      ),
      `Bachelor.s.Degree..High.Demand.Field...Academic.Disadvantage` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Academic.Disadvantage * `Bach-HDF-acadis-pct`),
        `Bachelor.s.Degree..High.Demand.Field...Academic.Disadvantage`
      ),
      `Bachelor.s.Degree..High.Demand.Field...Economic.Disadvantage` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Economic.Disadvantage * `Bach-HDF-ecodis-pct`),
        `Bachelor.s.Degree..High.Demand.Field...Economic.Disadvantage`
      ),
      `Bachelor.s.Degree..High.Demand.Field...Adult.Learner` = if_else(
        Year == 2025,
        round(TOTAL.Bachelor.s.Degree...Adult.Learner * `Bach-HDF-adult-pct`),
        `Bachelor.s.Degree..High.Demand.Field...Adult.Learner`))

log_qc("✅ Applied Bachelor historical percentages.", "INFO", "Apply Pcts")

# Remove historical pcts columns 
data_pcts <- data_pcts %>% 
  select(!contains("pct"))

log_qc(paste("✅ Finished applying all historical pcts; final data_pcts dims:", paste(dim(data_pcts), collapse = " x ")), "INFO", "Apply Pcts")

# QC: Flag unexpected percentage columns
extra_pct_cols <- setdiff(grep("-pct$", names(pct), value = TRUE), required_vars_pct2)
if (length(extra_pct_cols) > 0) {
  log_qc(
    paste0("❌ Unexpected or extra percentage columns detected in Average Pcts: ",
           paste(extra_pct_cols, collapse = ", ")),
    "WARN", "Average Pcts"
  )
}

# Outlier check comparing 2024 -> 2025 forecasts (hybrid rule)
outliers <- check_forecast_outliers(
  historical = data_transformed,
  forecast = data_pcts,
  abs_threshold = 20,
  pct_threshold = 0.25,
  min_val = 50)

 # Create Outlier table with specific formatting
outliers_table <- outliers %>%   
  mutate(
    pct_diff_num = round(pct_diff * 100, 0),  # numeric version for sorting
    pct_diff = paste0(pct_diff_num, "%")      # formatted version for display
  ) %>%
  relocate(Value_2024, .before = Forecast) %>%
  arrange(desc(pct_diff_num))                 # sort using numeric column

  # drop sorting column
  outliers_table <- outliers_table %>% 
    select(-pct_diff_num)
  

# Display the table in the console
if (exists("outliers_table") && nrow(outliers_table) > 0) {
  kable(
    head(outliers_table, 20),
    caption = "QC: Top 20 Columns of ETS & PCT Forecasts by Outlier Percentage Difference",
    align = c("l", "l", "l", "c", "c", "c", "c")) # left for cols 1-3, center for 4-7
} else {
  log_qc("ℹ️ No outliers detected in PCT forecasting.", "INFO", "Outlier QC")
}

```

## Combine PCT Forecasting Outliers with ETS Forecasting Outliers 
```{r combine_data}
# Path to the existing outliers Excel file
outlier_file <- params$existing_outliers

# Read existing file if it exists
if (file.exists(outlier_file)) {
  existing_outliers <- read.xlsx(outlier_file)
} else {
  existing_outliers <- tibble()  # empty tibble if file doesn't exist
}

# Combine existing outliers with new ones
combined_outliers <- bind_rows(existing_outliers, outliers) %>% 
  relocate(Value_2024, .before = Forecast) %>%
  distinct(FICE, Institution, Variable, Forecast, Value_2024, .keep_all = TRUE) %>% 
  arrange(Institution)

# Write back to Excel (overwrite)
write.xlsx(combined_outliers, outlier_file, overwrite = TRUE)


# Print confirmation
if (file.exists(outlier_file)) {
  log_qc(paste("✅ Exported combined outliers to", outlier_file), "INFO", "Outlier QC")
} else {
  log_qc(paste("❌ Combined outliers export failed for", outlier_file), "FAIL", "Outlier QC")
}
```

## Export PCT Forecasting Data
```{r export_final}
# Export final data with applied historical pcts
out_final <- "final-forecasts/fy25-official-all-forecasts.xlsx"
write.xlsx(data_pcts, out_final)

if (file.exists(out_final)) {
  log_qc(paste("✅ Exported final forecasts to", out_final), "INFO", "Export")
} else {
  log_qc(paste("❌ Final export failed for", out_final), "FAIL", "Export")
}

# Also save as tibble for use in parent RMD (fy25-unified-forecast)
fc_all <- data_pcts
```

## Export QC Log Summary for PCT Forecasting
```{r}
# Final QC summary
summarize_qc(qc_events, Final = TRUE)
```

